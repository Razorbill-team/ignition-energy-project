{
  "resource-type": "text-resource",
  "content-type": "text/javascript",
  "text": "// my_script.js\n(function () {\n  var DATA_URL = \"data\" + (window.location.search || \"\");\n\n  // -------- helpers ----------\n  function minuteLabel(hhmm){ var m=(hhmm||\"\").split(\":\")[1]||\"\"; return m ? (m + \"'\") : hhmm; }\n  function hourGroup(hhmm){ var h=(hhmm||\"\").split(\":\")[0]||\"\"; return h ? String(parseInt(h,10)) : hhmm; }\n  function num(v){\n    if (v == null) return 0;\n    if (typeof v === \"number\") return v;\n    var s = String(v).replace(/\\u00A0/g, \"\").replace(/\\s+/g, \"\");\n    var n = parseFloat(s.replace(/[^0-9.\\-]/g, \"\"));\n    return isNaN(n) ? 0 : n;\n  }\n  function normalizeRows(payload){\n    if (payload && Array.isArray(payload.columns) && Array.isArray(payload.rows)) {\n      var cols = payload.columns;\n      return payload.rows.map(function(r){ var o={}; for (var i=0;i<cols.length;i++) o[cols[i]] = r[i]; return o; });\n    }\n    if (payload && Array.isArray(payload.records)) return payload.records;\n    if (payload && Array.isArray(payload.json))    return payload.json;\n    if (Array.isArray(payload)) return payload;\n    return [];\n  }\n  function groupKey(d){ return [d.date, d.farm_name, d.status_name].join(\"|\"); }\n\n  var farmPalette = [\"farm-a\", \"farm-b\"];\n  var farmClassMap = {};\n  function getFarmClass(name){\n    if (!name) return \"\";\n    if (!farmClassMap.hasOwnProperty(name)) {\n      var idx = Object.keys(farmClassMap).length % farmPalette.length;\n      farmClassMap[name] = farmPalette[idx];\n    }\n    return farmClassMap[name];\n  }\n\n  var knownTimeCols = [];\n  var gridOptions = {\n    defaultColDef: {\n      sortable: true,\n      filter: true,\n      resizable: true,\n      suppressSizeToFit: true\n    },\n    rowSelection: \"multiple\",\n    animateRows: true,\n    pagination: true,\n    paginationPageSize: 50,\n\n    rowClassRules: {\n      'row-source-1': function(p){ return (p.data && String(p.data.Source_name||'').toLowerCase()==='source_1'); },\n      'row-source-2': function(p){ return (p.data && String(p.data.Source_name||'').toLowerCase()==='source_2'); },\n      'row-source-3': function(p){ return (p.data && String(p.data.Source_name||'').toLowerCase()==='source_3'); },\n      'row-avg':      function(p){ return (p.data && String(p.data.Source_name||'').toLowerCase()==='avg_sources'); },\n      'row-auto':     function(p){ return (p.data && String(p.data.Source_name||'').toLowerCase()==='auto_correction'); },\n      'row-manual':   function(p){ return (p.data && String(p.data.Source_name||'').toLowerCase()==='manual_correction'); },\n      'row-final':    function(p){ return (p.data && String(p.data.Source_name||'').toLowerCase()==='final_forecast'); },\n      'row-total':    function(p){ return (p.data && String(p.data.Source_name||'').toLowerCase()==='total_general'); },\n      'farm-a':       function(p){ return !!(p.data && getFarmClass(p.data.farm_name)==='farm-a'); },\n      'farm-b':       function(p){ return !!(p.data && getFarmClass(p.data.farm_name)==='farm-b'); }\n    },\n\n    onFirstDataRendered: function(){ setTimeout(recomputeAll, 0); },\n    onCellValueChanged: function(p){\n      if (p.colDef && p.colDef.colId === \"selected\") {\n        var key = groupKey(p.data || {});\n        setTimeout(function(){ recomputeForKey(key); recomputeTotals(); }, 0);\n      }\n    }\n  };\n\n  var gridDiv = document.getElementById(\"grid\");\n  var gridApi, columnApi;\n  if (agGrid.createGrid) {\n    gridApi = agGrid.createGrid(gridDiv, gridOptions);\n    columnApi = (gridApi.getColumnApi && gridApi.getColumnApi()) || gridApi.columnApi || null;\n  } else {\n    new agGrid.Grid(gridDiv, gridOptions);\n    gridApi = gridOptions.api;\n    columnApi = gridOptions.columnApi;\n  }\n\n  function setColumnDefs(colDefs){\n    if (gridApi && gridApi.setGridOption) gridApi.setGridOption(\"columnDefs\", colDefs);\n    else if (gridOptions.api) gridOptions.api.setColumnDefs(colDefs);\n  }\n  function setRowData(rows){\n    if (gridApi && gridApi.setGridOption) gridApi.setGridOption(\"rowData\", rows);\n    else if (gridOptions.api) gridOptions.api.setRowData(rows);\n  }\n\n  var groupMap = {};\n  var totalNode = null;\n\n  function rebuildMaps(){\n    groupMap = {}; totalNode = null;\n    gridApi.forEachNode(function(node){\n      var r = node.data || {};\n      var s = String(r.Source_name || \"\").toLowerCase();\n      if (s === \"total_general\") { totalNode = node; return; }\n      var key = groupKey(r);\n      var g = groupMap[key] || (groupMap[key] = {sources:{}, avg:null, auto:null, manual:null, final:null});\n      if (s === \"source_1\") g.sources[1] = node;\n      else if (s === \"source_2\") g.sources[2] = node;\n      else if (s === \"source_3\") g.sources[3] = node;\n      else if (s === \"avg_sources\") g.avg = node;\n      else if (s === \"auto_correction\") g.auto = node;\n      else if (s === \"manual_correction\") g.manual = node;\n      else if (s === \"final_forecast\") g.final = node;\n    });\n  }\n\n  function recomputeForKey(key){\n    var g = groupMap[key]; if (!g) return;\n\n    if (g.avg && g.avg.data) {\n      var avgRow = g.avg.data;\n      var srcNodes = [g.sources[1], g.sources[2], g.sources[3]].filter(function(n){ return n && n.data && n.data.selected; });\n      knownTimeCols.forEach(function(col){\n        var vals = srcNodes.map(function(n){ return num(n.data[col]); });\n        var mean = vals.length ? (vals.reduce(function(a,b){return a+b;}, 0) / vals.length) : 0;\n        avgRow[col] = Math.round(mean);\n      });\n      gridApi.refreshCells({ rowNodes:[g.avg], columns: knownTimeCols, force:true });\n    }\n\n    if (g.final && g.final.data) {\n      var finalRow = g.final.data;\n      knownTimeCols.forEach(function(col){\n        var sum = 0;\n        if (g.avg    && g.avg.data.selected)    sum += num(g.avg.data[col]);\n        if (g.auto   && g.auto.data.selected)   sum += num(g.auto.data[col]);\n        if (g.manual && g.manual.data.selected) sum += num(g.manual.data[col]);\n        finalRow[col] = Math.round(sum);\n      });\n      gridApi.refreshCells({ rowNodes:[g.final], columns: knownTimeCols, force:true });\n    }\n  }\n\n  function recomputeTotals(){\n    if (!totalNode) return;\n    var totals = {}; knownTimeCols.forEach(function(c){ totals[c]=0; });\n    gridApi.forEachNode(function(node){\n      var r = node.data || {};\n      if (String(r.Source_name || \"\").toLowerCase()===\"final_forecast\") {\n        knownTimeCols.forEach(function(c){ totals[c]+=num(r[c]); });\n      }\n    });\n    knownTimeCols.forEach(function(c){ totalNode.data[c]=Math.round(totals[c]); });\n    gridApi.refreshCells({ rowNodes:[totalNode], columns: knownTimeCols, force:true });\n  }\n\n  function recomputeAll(){ rebuildMaps(); Object.keys(groupMap).forEach(recomputeForKey); recomputeTotals(); }\n\n  function buildColumnDefs(rows, payload){\n    var cols = (payload && Array.isArray(payload.columns) && payload.columns.length)\n      ? payload.columns.slice(0)\n      : (rows[0] ? Object.keys(rows[0]) : []);\n    knownTimeCols = cols.filter(function(c){ return /^\\d{2}:\\d{2}$/.test(c); }).sort();\n    var firstTimeCol = knownTimeCols[0] || null;\n\n    var pinnedChildren = [\n      { field:\"site_name\",   headerName:\"Site_name\",   pinned:\"left\", width:110, minWidth:110 },\n      { field:\"farm_name\",   headerName:\"Farm_name\",   pinned:\"left\", width:140, minWidth:140 },\n      { field:\"status_name\", headerName:\"Status_name\", pinned:\"left\", width:110, minWidth:100 },\n      {\n        colId:\"selected\", headerName:\"\", pinned:\"left\",\n        width:49, minWidth:49, maxWidth:49, suppressMenu:true, sortable:false, filter:false,\n        headerClass:\"col-selected center-header\",\n        cellClass:\"col-selected\",\n        valueGetter:function(p){\n          var s = String(p.data && p.data.Source_name || \"\").toLowerCase();\n          if (s===\"final_forecast\" || s===\"total_general\") return null;\n          return !!(p.data && p.data.selected);\n        },\n        cellRenderer:function(params){\n          var s = String(params.data && params.data.Source_name || \"\").toLowerCase();\n          if (s===\"final_forecast\" || s===\"total_general\") return document.createElement(\"span\");\n          var el = document.createElement(\"input\");\n          el.type=\"checkbox\"; el.checked=!!params.value;\n          el.addEventListener(\"click\", function(e){\n            e.stopPropagation();\n            var v=el.checked;\n            if (params.node && params.node.data) params.node.data.selected=v;\n            if (params.node && params.node.setDataValue) params.node.setDataValue(\"selected\", v);\n            var key = [params.data.date, params.data.farm_name, params.data.status_name].join(\"|\");\n            setTimeout(function(){ recomputeForKey(key); recomputeTotals(); },0);\n          });\n          return el;\n        }\n      },\n      { field:\"Source_name\", headerName:\"Source_name\", pinned:\"left\", width:150, minWidth:150 }\n    ];\n    var pinnedGroup = { headerName:\"\", marryChildren:true, children: pinnedChildren };\n\n    var maybeIds = [];\n    [\"siteid\",\"farmid\"].forEach(function(f){ if (cols.indexOf(f)>=0) maybeIds.push({ field:f, hide:true }); });\n\n    var groupsMap = {};\n    knownTimeCols.forEach(function(f){ var g=hourGroup(f); (groupsMap[g]=groupsMap[g]||[]).push(f); });\n\n    var hourKeys = Object.keys(groupsMap).sort(function(a,b){ return parseInt(a,10)-parseInt(b,10); });\n\n    var grouped = hourKeys.map(function(g){\n      var children = groupsMap[g].sort().map(function(field){\n        var isSplit = (field === firstTimeCol);\n        return {\n          field: field,\n          headerName: minuteLabel(field),\n          headerClass: \"time-header center-header\" + (isSplit ? \" split-left\" : \"\"),\n          cellClass:  \"val-cell right\" + (isSplit ? \" split-left\" : \"\"),\n          filter: \"agNumberColumnFilter\",\n          width: 100, minWidth: 110,\n          valueFormatter: function(p){ return num(p.value).toLocaleString(); }\n        };\n      });\n      return {\n        headerName: g,\n        headerClass: \"center-group time-header hour-group\",\n        marryChildren: true,\n        children: children\n      };\n    });\n\n    return [pinnedGroup].concat(maybeIds).concat(grouped);\n  }\n\n  // -------- load data ----------\n  fetch(DATA_URL, { credentials:\"same-origin\" })\n    .then(function(r){ if(!r.ok) throw new Error(\"HTTP \"+r.status); return r.json(); })\n    .then(function(payload){\n      var rows = normalizeRows(payload);\n\n      rows.forEach(function(r){ getFarmClass(r.farm_name); });\n\n      rows.forEach(function(r){\n        var s = String(r.Source_name || \"\").toLowerCase();\n        r.selected = (s !== \"total_general\" && s !== \"final_forecast\");\n      });\n\n      var colDefs = buildColumnDefs(rows, payload || {});\n      setColumnDefs(colDefs);\n      setRowData(rows);\n\n      setTimeout(function(){\n        recomputeAll();\n        if (gridApi.redrawRows) gridApi.redrawRows();\n      }, 0);\n    })\n    .catch(function(err){\n      document.getElementById(\"grid\").innerHTML =\n        '<pre style=\"padding:8px;color:#c00\">Load error: ' + String(err) + '</pre>';\n      console.error(err);\n    });\n})();\n"
}